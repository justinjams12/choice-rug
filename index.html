<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Choice Floors - Rug Fabrication Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --choice-blue: #2b6291; 
            --choice-green: #9dbb4c;
            --choice-blue-light: #eef4f9;
            --text: #1e293b;
            --danger: #ef4444;
        }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: #f1f5f9; color: var(--text); padding-bottom: 60px; }
        .app-shell { width: 100%; max-width: 480px; margin: auto; padding: 15px; box-sizing: border-box; }
        
        .tabs { display: flex; background: var(--choice-blue); padding: 6px; border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; font-weight: 700; cursor: pointer; border-radius: 8px; opacity: 0.7; transition: all 0.2s; }
        .tab-btn.active { background: var(--choice-green); opacity: 1; color: white; }

        .view { display: none; }
        .view.active { display: block; }

        .live-result { background: var(--choice-blue); color: white; border-radius: 18px; padding: 25px; text-align: center; margin-bottom: 15px; position: relative; overflow: hidden; }
        .live-result::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: var(--choice-green); }
        
        .card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .section-title { font-size: 0.7rem; font-weight: 900; color: var(--choice-blue); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; display: flex; align-items: center; }
        .section-title::after { content: ''; height: 2px; flex-grow: 1; background: var(--choice-blue-light); margin-left: 10px; }

        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #e2e8f0; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; background-color: white; }
        label { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr; gap: 10px; }

        .side-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px; background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .side-option { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .side-option input { width: auto; margin: 0; cursor: pointer; }

        .btn { width: 100%; padding: 16px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; transition: all 0.2s; }
        .btn-add { background: var(--choice-blue); color: white; }
        .btn-add:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.6; }
        .btn-save { background: var(--choice-green); color: white; margin-top: 10px; }
        .btn-pdf { background: #334155; color: white; margin-top: 10px; }

        .room-tag { background: var(--choice-blue-light); padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--choice-green); }
        .fee-tag { background: #f8fafc; padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; border: 1px dashed #cbd5e1; display: flex; justify-content: space-between; font-size: 0.85rem; }
        .room-tag-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;}
        .room-tag-btns { display: flex; gap: 10px; }
        .btn-inline { background: none; border: none; font-size: 0.7rem; font-weight: bold; cursor: pointer; padding: 4px; border-radius: 4px;}
        .btn-edit { color: var(--choice-blue); }
        .btn-remove { color: var(--danger); }

        /* PDF TEMPLATE */
        #pdf-template { position: absolute; left: -9999px; width: 850px; background: #fff; color: #1e293b; padding: 0; }
        .pdf-header-wrapper { background: white; padding: 40px 60px 0 60px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-logo-img { height: 95px; width: auto; margin-bottom: 10px; }
        .pdf-title-block { text-align: right; padding-bottom: 15px; }
        .pdf-title-text { color: var(--choice-blue); margin: 0; font-size: 26px; font-weight: 900; text-transform: uppercase; }
        .pdf-wave-container { line-height: 0; margin-top: -1px; width: 100%; position: relative; }
        .pdf-body { padding: 40px 60px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin: 25px 0; }
        .pdf-table th { text-align: left; padding: 14px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 800; }
        .pdf-table td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: top; }
        .pdf-total-card { background: var(--choice-blue-light); padding: 25px; border-radius: 12px; width: 280px; float: right; text-align: right; border: 1px solid #dbeafe; }
    </style>
</head>
<body>

<div class="app-shell">
    <header style="text-align:center; padding: 10px 0 10px 0;">
        <img src="choice-floors-logo.png" style="max-height: 55px; width: auto;" alt="Choice Floors">
    </header>

    <div class="tabs">
        <button class="tab-btn active" id="tab-workspace" onclick="switchTab('workspace')">Quote Builder</button>
        <button class="tab-btn" id="tab-history" onclick="switchTab('history')">History</button>
    </div>

    <div id="workspace" class="view active">
        <div class="live-result">
            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9; margin-bottom: 5px;">Quote Total (Tax Inc.)</div>
            <div id="displayTotal" style="font-size: 2.2rem; font-weight: 900;">$0.00</div>
            <div id="taxInfo" style="font-size: 0.75rem; opacity: 0.8;">Enter details for tax...</div>
        </div>

        <div class="card">
            <div class="section-title">Client Details</div>
            <div class="grid-2">
                <input type="text" id="custFirst" placeholder="First Name *" oninput="autoCap(this); validateInputs()">
                <input type="text" id="custLast" placeholder="Last Name *" oninput="autoCap(this); validateInputs()">
            </div>
            <div class="grid-3">
                <input type="text" id="custCity" placeholder="City *" oninput="autoCap(this); validateInputs()">
                <select id="custState" onchange="lookupTax(); validateInputs()">
                    <option value="" disabled selected>ST *</option>
                    <option value="PA">PA</option><option value="DE">DE</option><option value="MD">MD</option><option value="NJ">NJ</option>
                </select>
                <input type="text" id="custZip" placeholder="Zip *" maxlength="5" oninput="handleZipChange()">
            </div>
        </div>

        <div class="card">
            <div class="section-title">Rug Dimensions & Finishing</div>
            <input type="text" id="roomName" placeholder="Room/Area Name *" oninput="autoCap(this); validateInputs()">
            <div class="grid-2">
                <div><label>Width (ft) *</label><input type="number" id="wA" oninput="validateInputs()"></div>
                <div><label>Length (ft) *</label><input type="number" id="lB" oninput="validateInputs()"></div>
            </div>

            <label>Finished Sides (Check to add Edge Work)</label>
            <div class="side-selector">
                <label class="side-option"><input type="checkbox" id="sideTop" checked onchange="validateInputs()"> Top (Width)</label>
                <label class="side-option"><input type="checkbox" id="sideBottom" checked onchange="validateInputs()"> Bottom (Width)</label>
                <label class="side-option"><input type="checkbox" id="sideLeft" checked onchange="validateInputs()"> Left (Length)</label>
                <label class="side-option"><input type="checkbox" id="sideRight" checked onchange="validateInputs()"> Right (Length)</label>
            </div>
            
            <div class="grid-2">
                <div><label>Edge Method</label><select id="edgeStyle" onchange="validateInputs()">
                    <option value="2.50">Binding ($2.50/Lft)</option>
                    <option value="6.00">Serging ($6.00/Lft)</option>
                </select></div>
                <div><label>Applied Backing</label><select id="backingStyle" onchange="handleMutualExclusion('backing')">
                    <option value="0">None</option>
                    <option value="1.50">Soft Felt ($1.50/sf)</option>
                    <option value="2.25">Teebaud ($2.25/sf)</option>
                </select></div>
            </div>
            <label>Loose Padding</label>
            <select id="padStyle" onchange="handleMutualExclusion('pad')">
                <option value="0">No Pad</option>
                <option value="1.15">Value Hold ($1.15/sf)</option>
                <option value="2.35">Double Grip ($2.35/sf)</option>
            </select>
            <div class="grid-2">
                <div><label>Delivery</label><select id="delv" onchange="updateLiveTotals()">
                    <option value="0">N/A</option>
                    <option value="125">Standard ($125)</option>
                </select></div>
                <div><label>Install</label><select id="inst" onchange="updateLiveTotals()">
                    <option value="0">N/A</option>
                    <option value="100">Pro ($100)</option>
                </select></div>
            </div>
            <button class="btn btn-add" id="btnAddRug" disabled onclick="addRug()">+ Add to Quote</button>
        </div>

        <div class="card" id="summaryCard" style="display:none;">
            <div class="section-title">Quote Summary</div>
            <div id="roomList"></div>
            <div id="feeList"></div>
            <button class="btn btn-save" onclick="saveJob()">Save Order</button>
            <button class="btn btn-pdf" onclick="generatePDF()">Download Professional PDF</button>
        </div>
    </div>

    <div id="history" class="view">
        <input type="text" id="jobSearch" class="search-input" placeholder="Search Last Name..." oninput="renderHistory()">
        <div id="historyList"></div>
    </div>
</div>

<div id="pdf-template">
    <div class="pdf-header-wrapper">
        <img src="choice-floors-logo.png" class="pdf-logo-img">
        <div class="pdf-title-block">
            <h1 class="pdf-title-text">Rug Fabrication Quote</h1>
            <p style="font-size: 13px;">Date: <span id="pdf-date"></span></p>
        </div>
    </div>
    <div class="pdf-wave-container">
        <svg viewBox="0 0 850 80" xmlns="http://www.w3.org/2000/svg">
            <path d="M0,40 C200,80 400,0 600,40 C800,80 850,50 850,50 L850,80 L0,80 Z" fill="#9dbb4c" opacity="0.8"/>
            <path d="M0,50 C200,10 400,90 600,50 C800,10 850,40 850,40 L850,80 L0,80 Z" fill="#2b6291"/>
        </svg>
    </div>
    <div class="pdf-body">
        <h2 id="pdf-client-name"></h2>
        <p id="pdf-client-address"></p>
        <p style="font-size: 10px; color: var(--danger);">* PRICING EXCLUDES CARPET MATERIAL *</p>

        <table class="pdf-table">
            <thead>
                <tr>
                    <th style="width: 30%;">Room/Area</th>
                    <th style="width: 20%;">Calculations</th>
                    <th style="width: 30%;">Finishing Specs</th>
                    <th style="width: 20%; text-align: right;">Cost</th>
                </tr>
            </thead>
            <tbody id="pdf-item-rows"></tbody>
        </table>

        <div style="overflow: auto; margin-top: 20px;">
            <div class="pdf-total-card">
                <div>Subtotal: <span id="pdf-subtotal"></span></div>
                <div>Tax (<span id="pdf-tax-rate"></span>%): <span id="pdf-tax-amount"></span></div>
                <div style="border-top: 1px solid #cbd5e1; margin-top: 10px; padding-top: 10px; font-size: 22px; font-weight: 900; color: var(--choice-blue);">Total: <span id="pdf-total-display"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRugs = [];
    let savedJobs = JSON.parse(localStorage.getItem('rugJobsMaster')) || [];
    let currentTaxRate = 0.00;

    function handleMutualExclusion(trigger) {
        const b = document.getElementById('backingStyle'), p = document.getElementById('padStyle');
        if (trigger === 'backing' && b.value !== "0") p.value = "0";
        if (trigger === 'pad' && p.value !== "0") b.value = "0";
        validateInputs();
    }

    function calculateLft() {
        const w = parseFloat(document.getElementById('wA').value) || 0;
        const l = parseFloat(document.getElementById('lB').value) || 0;
        let lft = 0;
        if(document.getElementById('sideTop').checked) lft += w;
        if(document.getElementById('sideBottom').checked) lft += w;
        if(document.getElementById('sideLeft').checked) lft += l;
        if(document.getElementById('sideRight').checked) lft += l;
        return lft;
    }

    function lookupTax() {
        const state = document.getElementById('custState').value;
        const rates = {"PA":0.06, "DE":0.00, "MD":0.06, "NJ":0.066};
        currentTaxRate = rates[state] || 0;
        updateLiveTotals();
    }

    function handleZipChange() { if(document.getElementById('custZip').value.length === 5) lookupTax(); validateInputs(); }

    function validateInputs() {
        const fields = ['custFirst','custLast','custState','custZip','roomName','wA','lB'];
        const anySideChecked = ['sideTop','sideBottom','sideLeft','sideRight'].some(id => document.getElementById(id).checked);
        document.getElementById('btnAddRug').disabled = !fields.every(id => document.getElementById(id).value.trim() !== "") || !anySideChecked;
        updateLiveTotals();
    }

    function updateLiveTotals() {
        const rugSub = currentRugs.reduce((a, b) => a + b.cost, 0);
        const activeLft = calculateLft();
        const w = parseFloat(document.getElementById('wA').value) || 0;
        const l = parseFloat(document.getElementById('lB').value) || 0;
        const eR = parseFloat(document.getElementById('edgeStyle').value) || 0;
        const bR = parseFloat(document.getElementById('backingStyle').value) || 0;
        const pR = parseFloat(document.getElementById('padStyle').value) || 0;
        
        const activeCost = (activeLft * eR) + ((w*l)*bR) + ((w*l)*pR);
        const d = parseFloat(document.getElementById('delv').value) || 0;
        const i = parseFloat(document.getElementById('inst').value) || 0;
        
        const subtotal = rugSub + activeCost + d + i;
        const tax = subtotal * currentTaxRate;
        
        document.getElementById('displayTotal').innerText = `$${(subtotal + tax).toFixed(2)}`;
        document.getElementById('taxInfo').innerText = `Subtotal: $${subtotal.toFixed(2)} | Tax: $${tax.toFixed(2)}`;
        renderFees(d, i);
    }

    function addRug() {
        const w = parseFloat(document.getElementById('wA').value), l = parseFloat(document.getElementById('lB').value);
        const lft = calculateLft();
        const e = document.getElementById('edgeStyle'), b = document.getElementById('backingStyle'), p = document.getElementById('padStyle');
        const cost = (lft * parseFloat(e.value)) + ((w*l) * parseFloat(b.value)) + ((w*l) * parseFloat(p.value));
        
        let sides = [];
        if(document.getElementById('sideTop').checked) sides.push("Top");
        if(document.getElementById('sideBottom').checked) sides.push("Bottom");
        if(document.getElementById('sideLeft').checked) sides.push("Left");
        if(document.getElementById('sideRight').checked) sides.push("Right");

        currentRugs.push({ 
            name: document.getElementById('roomName').value, w, l, lft, sqft: (w*l),
            edge: e.options[e.selectedIndex].text, backing: b.options[b.selectedIndex].text, 
            pad: p.options[p.selectedIndex].text, cost, sides: sides.join(", ")
        });
        
        renderRugs();
        ['roomName','wA','lB'].forEach(id => document.getElementById(id).value = "");
        updateLiveTotals();
    }

    function renderRugs() {
        document.getElementById('roomList').innerHTML = currentRugs.map((r, i) => `
            <div class="room-tag">
                <div class="room-tag-header"><b>${r.name}</b><button class="btn-inline btn-remove" onclick="removeRug(${i})">X</button></div>
                <div style="font-size: 0.75rem; opacity: 0.7;">${r.w}'x${r.l}' | Edges: ${r.sides} (${r.lft} lft)</div>
                <div style="font-weight:700; color:var(--choice-blue);">$${r.cost.toFixed(2)}</div>
            </div>`).join('');
        document.getElementById('summaryCard').style.display = 'block';
    }

    function renderFees(d, i) {
        let html = "";
        if(d > 0) html += `<div class="fee-tag"><span>Delivery</span><b>$${d.toFixed(2)}</b></div>`;
        if(i > 0) html += `<div class="fee-tag"><span>Installation</span><b>$${i.toFixed(2)}</b></div>`;
        document.getElementById('feeList').innerHTML = html;
    }

    function removeRug(i) { currentRugs.splice(i,1); renderRugs(); updateLiveTotals(); }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        document.getElementById('pdf-client-name').innerText = `${document.getElementById('custFirst').value} ${document.getElementById('custLast').value}`;
        document.getElementById('pdf-client-address').innerText = `${document.getElementById('custCity').value}, ${document.getElementById('custState').value}`;
        document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
        
        let rows = currentRugs.map(r => `
            <tr>
                <td><b>${r.name}</b></td>
                <td>${r.sqft} SF<br>${r.lft} LFT</td>
                <td><small>${r.edge}<br>Sides: ${r.sides}<br>Backing: ${r.backing}</small></td>
                <td style="text-align:right;">$${r.cost.toFixed(2)}</td>
            </tr>`).join('');

        const dVal = parseFloat(document.getElementById('delv').value), iVal = parseFloat(document.getElementById('inst').value);
        if(dVal > 0) rows += `<tr><td><b>Delivery</b></td><td>-</td><td>Standard</td><td style="text-align:right;">$${dVal.toFixed(2)}</td></tr>`;
        if(iVal > 0) rows += `<tr><td><b>Install</b></td><td>-</td><td>Pro</td><td style="text-align:right;">$${iVal.toFixed(2)}</td></tr>`;
        
        document.getElementById('pdf-item-rows').innerHTML = rows;
        const sub = currentRugs.reduce((a, b) => a + b.cost, 0) + dVal + iVal;
        document.getElementById('pdf-subtotal').innerText = `$${sub.toFixed(2)}`;
        document.getElementById('pdf-tax-rate').innerText = (currentTaxRate * 100).toFixed(1);
        document.getElementById('pdf-tax-amount').innerText = `$${(sub * currentTaxRate).toFixed(2)}`;
        document.getElementById('pdf-total-display').innerText = `$${(sub * (1 + currentTaxRate)).toFixed(2)}`;
        
        const canvas = await html2canvas(document.getElementById('pdf-template'), { scale: 2 });
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
        pdf.save(`Quote_${document.getElementById('custLast').value}.pdf`);
    }

    function saveJob() {
        const job = { id: Date.now(), fName: document.getElementById('custFirst').value, lName: document.getElementById('custLast').value, rugs: [...currentRugs], total: document.getElementById('displayTotal').innerText, date: new Date().toLocaleDateString() };
        savedJobs.unshift(job); localStorage.setItem('rugJobsMaster', JSON.stringify(savedJobs)); alert("Saved.");
    }

    function renderHistory() {
        const term = document.getElementById('jobSearch').value.toLowerCase();
        const filtered = savedJobs.filter(j => j.lName.toLowerCase().includes(term));
        document.getElementById('historyList').innerHTML = filtered.map(j => `<div class="card"><b>${j.lName}</b> - ${j.total}<br><small>${j.date}</small></div>`).join('');
    }

    function switchTab(t) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.getElementById('tab-' + t).classList.add('active');
        if(t === 'history') renderHistory();
    }

    function autoCap(el) { el.value = el.value.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
</script>
</body>
</html>
