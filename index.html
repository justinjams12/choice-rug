<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Choice Floors - Custom Rug Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --choice-blue: #2b6291; 
            --choice-green: #9dbb4c;
            --choice-blue-light: #eef4f9;
            --text: #1e293b;
            --danger: #ef4444;
            --danger-light: #fee2e2;
        }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: #f1f5f9; color: var(--text); padding-bottom: 60px; }
        .app-shell { width: 100%; max-width: 480px; margin: auto; padding: 15px; box-sizing: border-box; }
        
        /* UI Components */
        .tabs { display: flex; background: var(--choice-blue); padding: 6px; border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; font-weight: 700; cursor: pointer; border-radius: 8px; opacity: 0.7; transition: all 0.2s; }
        .tab-btn.active { background: var(--choice-green); opacity: 1; color: white; }

        .view { display: none; }
        .view.active { display: block; }

        .live-result { background: var(--choice-blue); color: white; border-radius: 18px; padding: 25px; text-align: center; margin-bottom: 15px; position: relative; overflow: hidden; }
        .live-result::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: var(--choice-green); }
        
        .card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .section-title { font-size: 0.7rem; font-weight: 900; color: var(--choice-blue); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; display: flex; align-items: center; }
        .section-title::after { content: ''; height: 2px; flex-grow: 1; background: var(--choice-blue-light); margin-left: 10px; }

        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #e2e8f0; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; background-color: white; }
        label { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 2fr 1fr 1.2fr; gap: 10px; }

        .btn { width: 100%; padding: 16px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; transition: all 0.2s; }
        .btn-add { background: var(--choice-blue); color: white; }
        .btn-add:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        
        .btn-save { background: var(--choice-green); color: white; margin-top: 10px; }
        .btn-pdf { background: #334155; color: white; margin-top: 10px; }

        .tax-alert { background: #fefce8; border: 1px solid #fef08a; padding: 10px; border-radius: 8px; font-size: 0.75rem; color: #854d0e; margin-bottom: 15px; display: none; }
        
        .room-tag { background: var(--choice-blue-light); padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--choice-green); display: flex; justify-content: space-between; align-items: center;}
        .room-info { flex-grow: 1; }
        .btn-remove-room { background: var(--danger-light); color: var(--danger); border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 0.7rem; cursor: pointer; margin-left: 10px; }

        .validation-msg { color: #64748b; font-size: 0.7rem; text-align: center; margin-top: 8px; font-style: italic; border: 1px dashed #cbd5e1; padding: 8px; border-radius: 8px; }

        /* --- BEAUTIFIED DETAILED PDF TEMPLATE --- */
        #pdf-template { position: absolute; left: -9999px; width: 850px; background: white; color: #1e293b; padding: 60px; font-family: 'Inter', sans-serif; }
        .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #f1f5f9; padding-bottom: 30px; margin-bottom: 30px; }
        .pdf-logo-box h1 { margin: 0; color: var(--choice-blue); font-size: 28px; font-weight: 900; }
        .pdf-logo-box p { margin: 0; color: var(--choice-green); font-weight: 700; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
        
        .pdf-meta-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; margin-bottom: 40px; }
        .pdf-info-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .pdf-info-value { font-size: 14px; font-weight: 600; color: #1e293b; line-height: 1.4; }

        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pdf-table th { text-align: left; padding: 12px 15px; background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .pdf-table td { padding: 18px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        
        .item-spec-list { font-size: 11px; color: #64748b; margin-top: 6px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; list-style: none; padding: 0; }
        .item-spec-list li b { color: #475569; }

        .pdf-totals-section { margin-top: 40px; display: flex; justify-content: flex-end; }
        .pdf-totals-table { width: 300px; }
        .pdf-totals-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
        .pdf-totals-row.grand-total { border-top: 2px solid var(--choice-blue); margin-top: 10px; padding-top: 15px; color: var(--choice-blue); font-size: 24px; font-weight: 900; }
    </style>
</head>
<body>

<div class="app-shell">
    <header style="text-align:center; padding: 10px 0 20px 0;">
        <img id="appLogo" src="choice-floors-logo.png" style="max-height: 50px; width: auto;" alt="Choice Floors">
    </header>

    <div class="tabs">
        <button class="tab-btn active" id="tab-workspace" onclick="switchTab('workspace')">Rug Design</button>
        <button class="tab-btn" id="tab-history" onclick="switchTab('history')">Saved Rugs</button>
    </div>

    <div id="workspace" class="view active">
        <div class="live-result">
            <div id="projectHeader" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9; margin-bottom: 5px;">Lead Info Required</div>
            <div id="displayTotal" style="font-size: 2.2rem; font-weight: 900;">$0.00</div>
            <div id="taxInfo" style="font-size: 0.75rem; opacity: 0.8;">Tax: $0.00 (Calculated by Zip)</div>
        </div>

        <div id="zipTaxAlert" class="tax-alert"></div>

        <div class="card" id="contactCard">
            <div class="section-title">Customer Contact</div>
            <div class="grid-2">
                <input type="text" id="custFirst" placeholder="First Name *" oninput="autoCap(this); updateLiveTotals()">
                <input type="text" id="custLast" placeholder="Last Name *" oninput="autoCap(this); updateLiveTotals()">
            </div>
            <div class="grid-2">
                <input type="tel" id="custPhone" placeholder="Phone (xxx) xxx-xxxx *" maxlength="14" oninput="formatPhoneNumber(this); updateLiveTotals()">
                <input type="email" id="custEmail" placeholder="Email Address *" oninput="updateLiveTotals()">
            </div>
            <input type="text" id="custStreet" placeholder="Street Address *" oninput="autoCap(this); updateLiveTotals()">
            <div class="grid-3">
                <input type="text" id="custCity" placeholder="City *" oninput="autoCap(this); updateLiveTotals()">
                <select id="custState" onchange="updateLiveTotals()">
                    <option value="" disabled selected>ST *</option>
                    <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
                    <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
                    <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
                    <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
                    <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
                    <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                    <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
                    <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
                    <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
                    <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
                    <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                    <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
                    <option value="WI">WI</option><option value="WY">WY</option>
                </select>
                <input type="text" id="custZip" placeholder="Zip *" maxlength="5" oninput="updateLiveTotals()">
            </div>
        </div>

        <div class="card">
            <div class="section-title">Rug Specifications</div>
            <input type="text" id="roomName" placeholder="Rug Location (e.g. Living Room) *" oninput="autoCap(this); updateLiveTotals()">
            <div class="grid-2">
                <div><label>Width (ft)</label><input type="number" id="wA" placeholder="0" oninput="updateLiveTotals()"></div>
                <div><label>Length (ft)</label><input type="number" id="lB" placeholder="0" oninput="updateLiveTotals()"></div>
            </div>
            <div class="grid-2">
                <div><label>Edge Finish</label>
                    <select id="edgeStyle" onchange="updateLiveTotals()">
                        <option value="2.50" data-label="Bind">Bind ($2.50/lf)</option>
                        <option value="6.00" data-label="Serge">Serge ($6.00/lf)</option>
                    </select>
                </div>
                <div><label>Attached Backing</label>
                    <select id="backingStyle" onchange="updateLiveTotals()">
                        <option value="0" data-label="None">None</option>
                        <option value="1.50" data-label="Soft Felt">Soft Felt ($1.50/sf)</option>
                        <option value="2.25" data-label="Teebaud">Teebaud ($2.25/sf)</option>
                        <option value="2.00" data-label="Quad Back">Quad Back ($2.00/sf)</option>
                    </select>
                </div>
            </div>
            <label>Area Rug Pad (Loose)</label>
            <select id="padStyle" onchange="updateLiveTotals()">
                <option value="0" data-width="999" data-label="None">No Pad</option>
                <option value="1.15" data-width="12" data-label="Value Hold">Value Hold ($1.15/sf)</option>
                <option value="2.35" data-width="12" data-label="Double Grip">Double Grip ($2.35/sf)</option>
                <option value="3.10" data-width="9" data-label="Teebaud">Teebaud ($3.10/sf)</option>
            </select>

            <div class="grid-2">
                <div><label>Delivery</label><select id="deliverySelect" onchange="updateLiveTotals()"><option value="0">No Delivery</option><option value="125">Delivery ($125)</option></select></div>
                <div><label>Installation</label><select id="installSelect" onchange="updateLiveTotals()"><option value="0">No Install</option><option value="100">Installation ($100)</option></select></div>
            </div>

            <button class="btn btn-add" id="btnAddRug" disabled onclick="addOrUpdateRug()">+ Add Rug to Quote</button>
            <div id="lockMessage" class="validation-msg">Every field & valid email required to unlock.</div>
        </div>

        <div class="card" id="roomListCard" style="display:none;">
            <div class="section-title">Quote Summary</div>
            <div id="currentRooms"></div>
            <button class="btn btn-save" onclick="finalizeJob()">Finalize & Save Job</button>
            <button class="btn btn-pdf" onclick="generatePDF()">Download PDF Quote</button>
        </div>
    </div>

    <div id="history" class="view">
        <div id="historyList"></div>
    </div>
</div>

<div id="pdf-template">
    <div class="pdf-header">
        <div class="pdf-logo-box">
            <h1>Choice Floors</h1>
            <p>Custom Rug Specification & Estimate</p>
        </div>
        <div style="text-align: right;">
            <div class="pdf-info-label">Estimate Date</div>
            <div id="pdf-date" class="pdf-info-value"></div>
        </div>
    </div>

    <div class="pdf-meta-grid">
        <div>
            <div class="pdf-info-label">Customer Information</div>
            <div id="pdf-cust-full" class="pdf-info-value" style="font-size: 18px;"></div>
            <div id="pdf-cust-contact" class="pdf-info-value" style="color: #64748b; font-weight: 400;"></div>
        </div>
        <div>
            <div class="pdf-info-label">Project Address</div>
            <div id="pdf-cust-street" class="pdf-info-value"></div>
            <div id="pdf-cust-cityline" class="pdf-info-value"></div>
        </div>
    </div>

    <table class="pdf-table">
        <thead>
            <tr>
                <th style="width: 65%;">Description & Specifications</th>
                <th style="width: 15%; text-align: center;">Dimensions</th>
                <th style="width: 20%; text-align: right;">Total Price</th>
            </tr>
        </thead>
        <tbody id="pdf-item-list"></tbody>
    </table>

    <div class="pdf-totals-section">
        <div class="pdf-totals-table">
            <div class="pdf-totals-row">
                <span style="color: #64748b;">Subtotal</span>
                <span id="pdf-subtotal" style="font-weight: 600;"></span>
            </div>
            <div class="pdf-totals-row">
                <span style="color: #64748b;">Tax (<span id="pdf-tax-rate"></span>%)</span>
                <span id="pdf-tax-amount" style="font-weight: 600;"></span>
            </div>
            <div class="pdf-totals-row grand-total">
                <span>Total</span>
                <span id="pdf-total-price"></span>
            </div>
        </div>
    </div>

    <div style="margin-top: 60px; padding-top: 20px; border-top: 1px solid #f1f5f9; font-size: 10px; color: #94a3b8; line-height: 1.5;">
        <b>Terms & Conditions:</b> This estimate is based on the dimensions provided and includes the specific edge, backing, and padding selections listed above. Final pricing is subject to physical verification of materials. This quote is valid for 30 days from the date listed.
    </div>
</div>

<script>
    let currentJobRugs = [];
    const CARPET_SQFT_PRICE = 5.00; 

    const stateTaxRates = { "PA": 6.0, "NY": 4.0, "NJ": 6.6, "MD": 6.0, "VA": 5.3, "DE": 0.0 };
    function getTaxRate() {
        const state = document.getElementById('custState').value;
        const zip = document.getElementById('custZip').value;
        let rate = stateTaxRates[state] || 6.0;
        if (state === "PA" && (zip.startsWith("190") || zip.startsWith("191"))) rate = 8.0;
        return rate;
    }

    function autoCap(input) {
        let words = input.value.split(' ');
        for (let i = 0; i < words.length; i++) {
            if (words[i].length > 0) words[i] = words[i].charAt(0).toUpperCase() + words[i].substring(1);
        }
        input.value = words.join(' ');
    }

    function formatPhoneNumber(input) {
        let val = input.value.replace(/\D/g, '');
        if (val.length > 0) {
            if (val.length <= 3) val = '(' + val;
            else if (val.length <= 6) val = '(' + val.substring(0, 3) + ') ' + val.substring(3);
            else val = '(' + val.substring(0, 3) + ') ' + val.substring(3, 6) + '-' + val.substring(6, 10);
        }
        input.value = val;
    }

    function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

    function updateLiveTotals() {
        const fields = ['custFirst', 'custLast', 'custPhone', 'custEmail', 'custStreet', 'custCity', 'custState', 'custZip'];
        const allContactFilled = fields.every(id => document.getElementById(id).value.trim() !== "");
        const rugFilled = document.getElementById('roomName').value.trim() !== "" && document.getElementById('wA').value !== "" && document.getElementById('lB').value !== "";
        const emailValid = isValidEmail(document.getElementById('custEmail').value);
        
        const w = parseFloat(document.getElementById('wA').value) || 0;
        const l = parseFloat(document.getElementById('lB').value) || 0;
        const subtotalCurrent = currentJobRugs.reduce((s, r) => s + r.cost, 0);
        
        let activeRugCost = 0;
        if (w > 0 && l > 0) {
            const e = document.getElementById('edgeStyle').value;
            const b = document.getElementById('backingStyle').value;
            const p = document.getElementById('padStyle').value;
            activeRugCost = (w * l * CARPET_SQFT_PRICE) + (((w*2)+(l*2)) * e) + (w * l * b) + (w * l * p);
        }

        const delivery = parseFloat(document.getElementById('deliverySelect').value);
        const install = parseFloat(document.getElementById('installSelect').value);
        
        const subtotal = subtotalCurrent + activeRugCost + delivery + install;
        const rate = getTaxRate();
        const taxAmount = subtotal * (rate / 100);
        const grandTotal = subtotal + taxAmount;

        document.getElementById('displayTotal').innerText = `$${grandTotal.toFixed(2)}`;
        document.getElementById('taxInfo').innerText = `Subtotal: $${subtotal.toFixed(2)} | Tax (${rate}%): $${taxAmount.toFixed(2)}`;
        
        const zip = document.getElementById('custZip').value;
        const taxAlert = document.getElementById('zipTaxAlert');
        if(zip.length === 5) {
            taxAlert.style.display = "block";
            taxAlert.innerText = `ðŸ“ Location identified. Sales tax for ${zip} is estimated at ${rate}%.`;
        }

        const addBtn = document.getElementById('btnAddRug');
        addBtn.disabled = !(allContactFilled && rugFilled && emailValid);
        document.getElementById('lockMessage').style.display = addBtn.disabled ? 'block' : 'none';
    }

    function addOrUpdateRug() {
        const roomName = document.getElementById('roomName').value;
        const w = parseFloat(document.getElementById('wA').value);
        const l = parseFloat(document.getElementById('lB').value);
        const e = document.getElementById('edgeStyle');
        const b = document.getElementById('backingStyle');
        const p = document.getElementById('padStyle');
        
        const cost = (w * l * CARPET_SQFT_PRICE) + (((w*2)+(l*2)) * parseFloat(e.value)) + (w * l * parseFloat(b.value)) + (w * l * parseFloat(p.value));
        
        currentJobRugs.push({ 
            name: roomName, 
            w, l, 
            cost,
            edge: e.options[e.selectedIndex].getAttribute('data-label'),
            backing: b.options[b.selectedIndex].getAttribute('data-label'),
            pad: p.options[p.selectedIndex].getAttribute('data-label')
        });
        
        updateRugList();
        ['roomName', 'wA', 'lB'].forEach(id => document.getElementById(id).value = "");
        updateLiveTotals();
    }

    function removeRug(index) {
        currentJobRugs.splice(index, 1);
        updateRugList();
        updateLiveTotals();
    }

    function updateRugList() {
        const container = document.getElementById('currentRooms');
        container.innerHTML = currentJobRugs.map((r, i) => `
            <div class="room-tag">
                <div class="room-info">
                    <b>${r.name}</b> (${r.w}' x ${r.l}')<br>
                    <small>${r.edge} Edge â€¢ ${r.backing} Backing</small>
                </div>
                <button class="btn-remove-room" onclick="removeRug(${i})">Remove</button>
            </div>`).join('');
        document.getElementById('roomListCard').style.display = currentJobRugs.length ? 'block' : 'none';
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const rate = getTaxRate();
        const delivery = parseFloat(document.getElementById('deliverySelect').value);
        const install = parseFloat(document.getElementById('installSelect').value);
        const subtotal = currentJobRugs.reduce((s, r) => s + r.cost, 0) + delivery + install;
        const tax = subtotal * (rate / 100);

        document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
        document.getElementById('pdf-cust-full').innerText = document.getElementById('custFirst').value + " " + document.getElementById('custLast').value;
        document.getElementById('pdf-cust-contact').innerText = document.getElementById('custPhone').value + "  |  " + document.getElementById('custEmail').value;
        document.getElementById('pdf-cust-street').innerText = document.getElementById('custStreet').value;
        document.getElementById('pdf-cust-cityline').innerText = `${document.getElementById('custCity').value}, ${document.getElementById('custState').value} ${document.getElementById('custZip').value}`;
        
        let rows = currentJobRugs.map(r => `
            <tr>
                <td>
                    <div style="font-weight: 700; color: var(--choice-blue); font-size: 14px;">Rug: ${r.name}</div>
                    <ul class="item-spec-list">
                        <li><b>Edge:</b> ${r.edge}</li>
                        <li><b>Backing:</b> ${r.backing}</li>
                        <li><b>Pad:</b> ${r.pad}</li>
                        <li><b>Labor:</b> Custom Fabrication</li>
                    </ul>
                </td>
                <td style="text-align: center; font-weight: 600;">${r.w}' x ${r.l}'</td>
                <td style="text-align: right; font-weight: 700; font-size: 14px;">$${r.cost.toFixed(2)}</td>
            </tr>`).join('');
        
        if(delivery > 0) rows += `<tr><td><div style="font-weight: 700;">Home Delivery Service</div><div style="font-size:11px; color:#64748b;">Professional transport to residence</div></td><td style="text-align:center;">-</td><td style="text-align:right; font-weight:700;">$${delivery.toFixed(2)}</td></tr>`;
        if(install > 0) rows += `<tr><td><div style="font-weight: 700;">Professional Installation</div><div style="font-size:11px; color:#64748b;">On-site placement and adjustment</div></td><td style="text-align:center;">-</td><td style="text-align:right; font-weight:700;">$${install.toFixed(2)}</td></tr>`;

        document.getElementById('pdf-item-list').innerHTML = rows;
        document.getElementById('pdf-subtotal').innerText = `$${subtotal.toFixed(2)}`;
        document.getElementById('pdf-tax-rate').innerText = rate;
        document.getElementById('pdf-tax-amount').innerText = `$${tax.toFixed(2)}`;
        document.getElementById('pdf-total-price').innerText = `$${(subtotal + tax).toFixed(2)}`;

        const canvas = await html2canvas(document.getElementById('pdf-template'), { scale: 2 });
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
        pdf.save(`Estimate_${document.getElementById('custLast').value}.pdf`);
    }

    function switchTab(t) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
    }

    function finalizeJob() {
        alert("Estimate successfully finalized and saved.");
        location.reload();
    }
</script>
</body>
</html>
